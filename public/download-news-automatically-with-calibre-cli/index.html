<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="shortcut icon" href="http://example.org/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.min.css">

    <title>使用 Calibre 的命令行工具下载新闻</title>
</head>
<body><header id="banner">
    <h2><a href="http://example.org/">Neverland</a></h2>
    <nav>
        <ul>
            
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>使用 Calibre 的命令行工具下载新闻</h1>
        <div>
                <time>Aug 17, 2019</time>
            </div>
    </header><p>Calibre 具有完善的<a href="https://manual.calibre-ebook.com/news.html">新闻下载功能</a>，可以从各种媒体的网站抓取最新的文章并生成电子书文件。得益于开源社区的贡献，它还内置了针对一千多个不同网站编写的<a href="https://github.com/kovidgoyal/calibre/tree/master/recipes">配置方案</a>（称作 recipe），并且更新非常及时。</p>
<p>但是，Calibre 的图形界面非常简陋且经常卡顿，使用起来体验较差。如果要使用定时下载新闻的功能，还必须保证软件一直在后台运行。另外，如果想在 Linux 服务器上运行 Calibre，一般也没有图形界面可用。</p>
<p><img src="https://cl.ly/89866a/calibre-fetch-news.png" alt="Calibre 一言难尽的图形界面"></p>
<p>Calibre 一言难尽的图形界面</p>
<p>因此，使用命令行来下载新闻是更快捷、通用、且适合自动化的做法。本文将介绍用 Calibre 的命令行工具下载新闻的一般方法，然后在此基础上说明如何配置自动运行，并将下载好的文件通过不同方式传输到其他设备上阅读。</p>
<h3 id="基本用法">基本用法</h3>
<p>Calibre 在命令行中的新闻下载功能是整合在其格式转换命令 <a href="https://manual.calibre-ebook.com/generated/en/ebook-convert.html"><code>ebook-convert</code></a> 中的。其基本用法是：</p>
<pre tabindex="0"><code>ebook-convert &quot;Title of news source.recipe&quot; outputfile.epub
</code></pre><p>其中，第一个参数是 recipe 的名称。不过，Calibre 在文档中没有指出的是，在使用内置方案时，<code>Title of news source.recipe</code> 不是指内置方案的文件名，而是指新闻网站的全称，<code>.recipe</code> 不是扩展名，只是一个后缀。只有在找不到对应的内置方案时，Calibre 才认为该参数是自定义方案的绝对路径。</p>
<p>要知道自己想阅读的网站有没有专用的内置方案，除了可以在 Calibre 的图形界面的新闻下载界面中查询，还可以使用 <code>ebook-convert --list-recipes</code> 命令。例如：</p>
<pre tabindex="0"><code>$ ebook-convert --list-recipes | grep 'New York Times'
	New York Times Book Review
	New York Times Sports Beat
	New York Times Technology Beat
	The New York Times
	The New York Times (Web)
</code></pre><p>所以，如果要下载当天的《纽约时报》，完整的命令应该是</p>
<pre tabindex="0"><code>ebook-convert &quot;The New York Times.recipe&quot; nytimes.epub
</code></pre><p>下载所得的 EPUB 文件如下图所示，除个别特殊样式不能正常显示之外，整体效果比较令人满意。</p>
<p><img src="https://cl.ly/8428e1/calibre-nyt.png" alt="用 Calibre 下载的报纸"></p>
<p>用 Calibre 下载的报纸</p>
<h3 id="定时下载报纸期刊">定时下载报纸期刊</h3>
<p>对于更新时间固定的报纸或期刊，在每次出新时手动下载显然是没有必要的。另外，最好能够在所下载文件的名称中标明日期，以便区分。</p>
<p>还是以下载每天的《纽约时报》为例。创建一个名为 <code>getnyt.sh</code> 的脚本文件（同时使用 <code>chmod +x</code> 为其增加运行权限），其内容为：</p>
<pre tabindex="0"><code>#!/bin/bash

TODAY=$(date +%m%d)
ebook-convert &quot;The New York Times.recipe&quot; nytimes-$TODAY.epub
</code></pre><p>这里，<code>TODAY</code> 变量使用了 <code>date</code> 命令的自定义日期格式功能，为下载的文件标注了日期。其他更复杂的日期格式可以用 <code>man date</code> 查阅。</p>
<p>下一个要解决的问题是如何让脚本定期运行。在 macOS 或 Linux 上，显而易见的答案是使用 <code>cron</code>。运行 <code>crontab -e</code> 打开 crontab 文件的编辑界面，在其中加入：</p>
<pre tabindex="0"><code>CRON_TZ=America/New_York
30 0 * * * /root/getnyt.sh &gt;/dev/null 2&gt;&amp;1
</code></pre><p>这里用到了 <code>CRON_TZ</code> 变量来指定时区。《纽约时报》的更新时间是美国东部时间每天凌晨，虽然可以手工换算成国内时区，但直接使用纽约时区可以避免考虑夏时制的问题。<code>30 0 * * *</code> 指全年每月、每周七天的 0:30 分。类似地，对于一般每周四中午更新周刊内容的《经济学人》，相应的 cron 日程应该是 <code>0 12 * * 4</code>。（更详细的 cron 日程写法可以使用<a href="https://crontab.guru">这个工具</a>阅读并测试。）</p>
<p>最后，由于 Calibre 在下载新闻时会输出很多日志，这里用<code>&gt;/dev/null 2&gt;&amp;1</code> 让脚本静默运行。</p>
<h3 id="将下载的期刊发送给其他设备">将下载的期刊发送给其他设备</h3>
<p>当然，新闻下载成电子书格式以后，终归还是要搬运到其他设备里阅读的。具体做法因需求而异，包括：</p>
<p>**直接连接到服务器下载：**如果你使用 iPad 等设备作为阅读器，那么可以直接使用 Documents 这类支持 SFTP 的文件管理工具登录服务器下载。</p>
<p>**添加到 Calibre 资料库：**如果你习惯用 Calibre 来管理所有的电子书，并且就是在平时存放 Calibre 资料库的电脑上运行脚本，那么可以考虑将下载好的电子书直接添加到资料库。Calibre 在命令行下使用 <a href="https://manual.calibre-ebook.com/generated/en/calibredb.html"><code>calibredb</code></a> 工具来维护资料库，对应的完整命令形如：</p>
<pre tabindex="0"><code>calibredb add --with-library /path/to/library nytimes.epub
</code></pre><p>你还可以进一步使用 Calibre 的<a href="https://manual.calibre-ebook.com/server.html">内容服务器</a>功能在其他设备上访问下载好的新闻。</p>
<p>**存入网盘：**如果你是在远程服务器上运行 Calibre 下载新闻，那么更实际的方法或许是直接把下载好的电子书存进网盘。这可以通过 <a href="https://rclone.org/">rclone</a> 来实现。该工具支持包括 Dropbox、OneDrive 和 Google Drive 等各大主流在线存储服务，具体的<a href="https://rclone.org/overview/">配置方式</a>可以参考官方文档。以 OneDrive 为例，配置好以后，在上文脚本后加入一行</p>
<pre tabindex="0"><code>rclone copy nytimes.epub onedrive:/Documents/News; rm nytimes.epub
</code></pre><p>即可将 Calibre 下载的期刊文件转移到网盘。</p>
<p>如果想使用百度网盘，那么也可以配置 <a href="https://github.com/iikira/BaiduPCS-Go">BaiduPCS-Go</a>，然后使用 <code>BaiduPCS-Go upload</code> 命令来上传。</p>
<p>**通过邮件发送：**最后，你也可以考虑将下载好的新闻通过邮件形式发送。这对于 Kindle 用户可能尤其实用，因为可以配合 Kindle 的文档服务功能实现新闻推送的效果。</p>
<p>Calibre 内置了一个用于发送邮件的命令行工具 <code>calibre-smtp</code>。由于该命令涉及的参数太多，建议使用脚本和变量来控制。例如，下面片段的作用是以 Gmail 发送下载好的当日《纽约时报》（注意很多开启了两步验证的邮件服务需要<a href="https://support.google.com/accounts/answer/185833?p=InvalidSecondFactor&amp;visit_id=637016307474904521-2410294637&amp;rd=1&amp;hl=zh-Hans">配置专用密码</a>）。</p>
<pre tabindex="0"><code>TODAY=$(date +%m%d)
DATELONG=$(date +%Y/%m/%d)
SMTP=&quot;smtp.gmail.com&quot;
PORT=&quot;587&quot;
USER=&quot;username&quot;
PASSWD=&quot;password&quot;
FROM=&quot;from@gmail.com&quot;
TO=&quot;to@kindle.com&quot;
MSG=&quot;Please find attached today’s New York Times. Have a good day!&quot;

calibre-smtp --attachment nytimes-$TODAY.epub --relay &quot;$SMTP&quot; --port &quot;$PORT&quot; --username &quot;$USER&quot; --password &quot;$PASSWD&quot; --encryption-method TLS --subject &quot;Today’s New York Times ($DATELONG)&quot; &quot;$FROM&quot; &quot;$TO&quot; &quot;$MSG&quot;
</code></pre><h3 id="额外考虑calibre-的网络环境配置">额外考虑：Calibre 的网络环境配置</h3>
<p>最后需要考虑的是，如果你的服务器本身访问新闻网站有困难，Calibre 也无法直接下载新闻。Calibre 遵从系统的代理设置，支持的代理类型为 HTTP 和 HTTPS，但不包括 Socks（但可以先通过 <a href="https://www.privoxy.org">Privoxy</a>、<a href="https://proxifier.com/">Proxifier</a> 这类工具转换）。对于 macOS，该设置位于「系统偏好设置」&gt;「网络」&gt;「高级」&gt;「代理」；对于 Windows 10，则位于「设置」&gt;「网络和 Internet」&gt;「代理」。Linux 系统或者使用脚本的场景，则需执行：</p>
<pre tabindex="0"><code>export https_proxy=https://username:password@servername; export http_proxy=http://username:password@servername
</code></pre></article>

        </main><footer id="footer">
    
</footer>
</body>
</html>
