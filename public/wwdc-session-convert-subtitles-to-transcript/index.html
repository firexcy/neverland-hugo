<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="shortcut icon" href="http://example.org/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.min.css">

    <title>从无文字版 WWDC 视频的字幕转制文字版</title>
</head>
<body><header id="banner">
    <h2><a href="http://example.org/">Neverland</a></h2>
    <nav>
        <ul>
            
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>从无文字版 WWDC 视频的字幕转制文字版</h1>
        <div>
                <time>Jun 13, 2021</time>
            </div>
    </header><p>大多数 WWDC 视频都配有文字版，在视频页面点击「Transcript」即可看到，还可以下载 TXT 格式版本。但也有少量视频（例如 <a href="https://developer.apple.com/videos/play/wwdc2021/10029/">Design for Safari 15</a>）没有文字版，给检索和浏览造成不便。实际上，这类视频也有自动转写的字幕，只要下载后简单处理即可当作文字版浏览。</p>
<p>以上述 <a href="https://developer.apple.com/videos/play/wwdc2021/10029/">Design for Safari 15</a> 讲座为例。</p>
<p>首先，用抓包工具（例如 Surge 或 Proxyman）抓取 WWDC 视频的域名 devstreaming-cdn.apple.com，并开始播放视频。</p>
<p>请求中，形如</p>
<pre tabindex="0"><code>https://devstreaming-cdn.apple.com/videos/wwdc/2021/10029/4/8B75DA3D-09DF-40FD-AC0E-FB6A7EECE3F1/subtitles/eng/prog_index.m3u8 
</code></pre><p>的即是获取字幕片段播放列表的请求，其内容为：</p>
<pre tabindex="0"><code>EXTM3U
#EXT-X-TARGETDURATION:7.0
#EXT-X-VERSION:3
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-PLAYLIST-TYPE:VOD
#EXTINF:6.006
sequence_0.webvtt
#EXTINF:6.006
sequence_1.webvtt
[...]
#EXTINF:6.006
sequence_334.webvtt
#EXTINF:0.3
sequence_335.webvtt
#EXT-X-ENDLIST
</code></pre><p>显然，这表明该视频的字幕共有从 <code>sequence_0.webvtt</code> 到 <code>sequence_335.webvtt</code> 共 336 个片段。</p>
<p>这样，在终端通过 <code>wget</code> 配合简单的循环即可批量下载：</p>
<pre tabindex="0"><code>counter=0
while [[ $counter -le 335 ]]
do
  wget &quot;https://devstreaming-cdn.apple.com/videos/wwdc/2021/10029/4/8B75DA3D-09DF-40FD-AC0E-FB6A7EECE3F1/subtitles/eng/sequence_$counter.webvtt&quot;
  ((counter++))
done
</code></pre><p>然后再通过一个循环将这些分段字幕合并为一个完整字幕：</p>
<pre tabindex="0"><code>counter=0
while [[ $counter -le 335 ]]                                                                  130
do
  cat &quot;sequence_$counter.webvtt&quot; &gt;&gt; full.webvtt
  ((counter++))
done
</code></pre><p>不过，<code>webvtt</code> 格式的字幕文件里有时间轴、格式信息和很多空行，并不方便阅读：</p>
<pre tabindex="0"><code>WEBVTT

00:19:58.498 --&gt; 00:20:01.735 line:-2 align:center
Next, let’s talk about several
of the amazing new features

00:20:01.768 --&gt; 00:20:03.904 align:center line:-1
of macOS, iOS, and iPadOS

00:20:03.937 --&gt; 00:20:06.306 line:-1 align:center
and how they’ll impact the web.

00:20:06.340 --&gt; 00:20:10.043 line:-2 align:center
Often, the very first experience
people will have of your website
</code></pre><p>解决方法也很简单，用随便一个支持正则表达式的文本编辑器搜索相关 pattern 批量删除即可。例如 Vim 中可以：</p>
<pre tabindex="0"><code>:g/WEBVTT/d
:g/--&gt;/d
:g/\v^$/d
</code></pre><p>最后，由于是自动生成的字幕，会有不少同一句话出现两次的情况，这也可以通过正则表达式批量清理：</p>
<pre tabindex="0"><code>:g/\n^(.*)$\n\1/d
</code></pre></article>

        </main><footer id="footer">
    
</footer>
</body>
</html>
